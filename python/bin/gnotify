#!/usr/bin/python
"""
A python script that sends notifications to the Growl daemon 
See <http://Growl.info> for more information.

Requires PyObjC 1.1 <http://pyobjc.sourceforge.net/> and Python 2.3
<http://www.python.org/>.

Copyright 2004 Jeremy Rossi <jeremy@jeremyrossi.com>
Released under the BSD license.

Modified by Kevin Ballard <kevin@sb.org>
"""

import Growl
from Foundation import NSRunLoop, NSDate
from AppKit import NSWorkspace
import getopt, sys, os.path

def usage():
    sys.stdout.write("""%s: 
    -n,--name     Specify the name of them Application that is sending the
                  notification [Default: gNotify]
    -i,--icon     Specify a filetype or extension to be used for the icon
    -I,--iconpath Specify a filepath to be used for the icon
                  This option overrides --icon
    -t,--title    Title to be used in each notification [Default: gNotify]
    -m,--message  Text to be send to the daemon.  - is used to for stdin
                  For each line (IE: \\n) a new notifaction is sent
""" % sys.argv[0])

NOTIFICATION_NAME = 'Dynamic Messages'

def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], "n:t:m:i:I:", ["name=", "title=", "message=","icon=","iconpath="])
    except getopt.GetoptError:
        # print help information and exit:
        usage()
        sys.exit(2)
    
    # print help information and exit if no options were given - we don't need to display a blank bubble
    if not opts:
        usage()
        sys.exit(2)
    
    appName = "gNotify"
    nTitle = "gNotify"
    nMsg = ""
    nIconType = ""
    nIconPath = ""
    for o, a in opts:
        if o in ("-n", "--name"): appName = a
        elif o in ("-t", "--title"): nTitle = a
        elif o in ("-m", "--message"): nMsg = a
        elif o in ("-i", "--icon"): nIconType = a
        elif o in ("-I", "--iconpath"): nIconPath = a
    
    nIcon = None
    if nIconPath != '':
        nIconPath = os.path.abspath(nIconPath)
        nIcon = NSWorkspace.sharedWorkspace().iconForFile_(nIconPath)
    elif nIconType != '':
        nIcon = NSWorkspace.sharedWorkspace().iconForFileType_(nIconType)
    if nIcon is None:
    	nIcon = NSWorkspace.sharedWorkspace().iconForFileType_('unknown')
    
    class TestGrowlNotifier(Growl.GrowlNotifier):
        applicationName = appName
        notifications = [NOTIFICATION_NAME]
    n = TestGrowlNotifier(applicationIcon=nIcon)
    n.register()
    
    # A small delay to ensure our notification will be shown.
    NSRunLoop.currentRunLoop().runUntilDate_(NSDate.dateWithTimeIntervalSinceNow_(0.1))
    if nMsg == "-":
        while 1:
            i = sys.stdin.readline()
            if not i: break
            n.notify(NOTIFICATION_NAME, nTitle, i)
    else:
        n.notify(NOTIFICATION_NAME, nTitle, nMsg)

if __name__ == '__main__':
    main()
